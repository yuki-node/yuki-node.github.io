---
title: 'Google 代码审查指南'
date: '2025-08-27T10:00:00+08:00'
draft: false
tags: ['代码审查', '软件工程', '最佳实践']
keywords: ['Google', '代码审查', 'Code Review', '软件工程', '最佳实践']
author: "Yuki"
---

> *本文翻译自：[Google 工程实践文档](https://google.github.io/eng-practices/)*
> 
> *许可：[CC-By 3.0 License](https://creativecommons.org/licenses/by/3.0/)*

# 前言 {#preface}

在 Google 有许多通用的工程实践，几乎涵盖了所有语言和项目。此文档为长期积累的最佳实践，是集体经验的结晶。我们尽可能地将其公之于众，你的组织和开源项目也会从中受益。

[Google 的 Code Review 指南](#introduction)，实际包含以下两个单独的文档：
- [代码审查者指南](#code_reviewer_guide)：给进行 Code Review 的审查者提供的详细指南。
- [代码变更者指南](#code_change_guide)：给进行代码变更的开发者提供的详细指南。

## 术语 {#terms}

其中一些文档中使用了一些 Google 内部术语，我们在这里为外部读者澄清：

- **CL**: "Change List" 的缩写，表示一个已提交到版本控制或正在进行代码审查的独立更改。在其他组织内可能会将其称为 "change"、"patch" 或 "pull request"。
- **LGTM**: "Looks Good to Me" 的缩写，审查者说了这句代码变更通过了。

---

# 介绍 {#introduction}

Code Review 是除了代码作者之外，其他人检查代码的过程。

Google 通过 Code Review 来维护代码和产品质量，此文档则是 Google Code Review 流程和政策的规范说明。

## 代码审查者应该关注哪些方面？ {#look_for_in_code_review}

Code Review 时应该关注以下方面：
- **设计**：代码是否经过精心设计并适合你的系统？
- **功能**：代码的行为是否与作者的意图相同？代码是否可以正常响应用户的行为？
- **复杂性**：代码能更简单吗？将来其他开者能轻松理解并使用此代码吗？
- **测试**：代码是否具有正确且设计良好的自动化测试？
- **命名**：开发者是否为变量、类、方法等选择了清晰的名称？
- **注释**：注释是否清晰有用？
- **风格**：代码风格是否遵守了 [Google 代码风格指南](https://google.github.io/styleguide/)？
- **文档**：开发者是否同时更新了相关文档？

### 选择最合适的审查者 {#pick_reviewer}

一般而言，你希望找到能在合理的时间内回复你的代码提交的最合适的审查者。

最合适的审查者应该是能彻底了解和审查你代码的人。他们通常是代码的所有者，可能是 owner(s) 文件中的人，也可能不是。有时 CL 的不同部分可能需要不同的人审查。

如果你找到了理想的审查者但他们又没空，那你也至少也要抄送他们。

### 面对面审查（和结对编程） {#face_to_face_review}

如果你与有资格做 Code Review 的人一起结对编程了一段代码，那么该代码可被视为已审查。

你还可以进行面对面的代码审查，审查者提问，CL 的开发者作答。

---

# 代码审查者指南 {#code_reviewer_guide}

## Code Review 的标准 {#code_review_standard}

Code Review 的主要目的是确保逐步改善 Google 代码库的整体健康状况。Code Review 的所有工具和流程都是为此而设计的。

为了实现此目标，必须做出一系列权衡。

**首先，开发者必须能够对代码进行优化。** 如果你从未向代码库提交优化变更，那代码库永远不会改进。此外，如果审查者对代码吹毛求疵，那么开发者可能未来会不再提交优化变更。

**另外，审查者有责任确保随着时间的推移，CL 的质量不会使代码库的整体健康状况下降。** 这可能很棘手，因为通常情况下，代码库的健康状况会随着时间的推移而下降，特别是在团队有严格的时间要求时，他们必须走捷径才能完成目标时。

**此外，审查者应对正在审核的代码负责并拥有所有权。** 审查者希望确保代码库保持一致、可维护及 [Code Review 的关注点](#code_review_focus)中提到的所有其他内容。

因此，我们将以下规则作为 Code Review 中期望的标准：

<span style="color:green">**总体来说，只要 CL 真的可以提高系统的整体代码健康状态，即使这个 CL 并不完美，审查者也应该倾向于批准该 CL。**</span>

这是所有 Code Review 指南中的**核心**原则。

当然，也有一些限制。例如，如果 CL 添加了审查者认为系统中不需要的功能，那么即使代码设计良好，审查者依然可以拒绝批准它。

这里有个关键点，没有『完美的』代码 -- 只有『更好的』代码。审查者不该要求开发者在提交变更前仔细清理、润色 CL 的每个角落。相反，审查者应该权衡改进需求和进度推进之间的平衡。与其追求完美，不如聚焦持续优化。只要这个 CL 能提升代码整体的可维护性、可读性和可理解性，就不应该因为不够『完美』而延误数日甚至数周才合并。

**注意：** 本文内容绝不应被用作提交会使系统整体代码健康状况下降的 CL 的理由。只有在 [紧急情况](#emergency_changes) 下才能这么做。

### 指导 {#guidance}

Code Review 承担着重要的教学功能——开发者能借此了解语言特性、框架机制或通用软件设计原则的新知识。留下评论可以帮助开发者学习新东西，知识共享本身就是持续提升系统代码健康度的重要环节。
但需注意，如果你的评论纯粹是教育性的，且对于本文档中描述的标准并不重要，请在其前面添加 "Nit:" （Nitpick 吹毛求疵的缩写）或以其他方式表明可以不必在此 CL 中解决它。

### 原则 {#principles}

- 技术事实与数据高于观点和个人偏好。

- 在代码风格问题上，[Google 代码风格指南](https://google.github.io/styleguide/) 具有绝对权威。凡未纳入风格指南的纯样式问题（如空格使用等）均属个人偏好范畴，但需保持与既有代码风格一致。若无先例可循，则应采纳开发者的风格方案。

- **软件设计层面的问题几乎从不属于纯样式或个人偏好范畴，其判断应基于底层设计原则进行权衡，而非个人喜好意见。** 若存在多个有效方案，且开发者能通过数据或扎实的工程原理证明多种方法均属合理，审查者应尊重开发者的选择。否者，遵循软件设计的标准原则。

- 如果没有其他规则适用，审查者可要求开发者与现有代码库保持一致，只要这个要求不会使代码整体恶化。

### 解决分歧 {#resolve_disagreements}

如果在 Code Review 过程中有任何分歧，第一步应该始终是开发者和审查者基于本文中的 [代码变更者指南](#code_change_guide) 和 [代码审查者指南](#code_reviewer_guide) 达成共识。

当共识难以达成时，进行面对面会议或视频会议往往比仅通过代码评审注释解决分歧更有效。（若采用此方式，务必将讨论结果记录到提交评论中，以供后续查阅。）

若还是无法解决分歧，最常见的处理方式是升级决策。通常可采取以下路径：发起更广泛的团队讨论、征求技术主管意见、让代码维护者判断或找工程经理帮助。**不要因为开发者与审查者没达成一致就让 CL 在那搁置。**

## Code Review 的关注点 {#code_review_focuses}

注意：当考虑以下每一点时，一定要先确保考虑到上面 [Code Review 的标准](#code_review_standard)。

### 设计 {#design}

Review 中最重要的事情是 CL 的整体设计。CL 中各种代码片段的交互是否有意义？该变更是属于你负责的代码库还是公共的 library 库？是否与你系统很好地集成？现在是添加这个功能的好时机吗？

### 功能 {#functionality}

这个 CL 提交是否符合了开发者的设计意图？该设计意图是否对代码用户有益？这里『用户』通常既是最终用户（当他们受到更改的影响时）也包括开发者（他们将来必须『使用』此代码）。

原则上，我们要求开发者在提交 CL 前对代码进行充分测试以确保功能正确。但作为评审者，你仍应考虑边界情况、排查并发问题、尝试站在用户角度思考，并通过代码评审确保没有明显的 BUGs。

如果你正在审查的这个 CL 会对用户产生重大影响（如 UI 变更），那么你就很有必要验证 CL 的效果。仅通过代码阅读往往难以完全理解变更对用户的影响。如果在 CL 中打 patch 或自行部署验证不太方便，可以让开发者为你提供功能演示。

在 Code Review 中，如果 CL 中存在**并行编程**的提交，功能可靠性就特别重要。此类代码可能引发死锁或竞态条件问题。这些隐患很难通过简单运行暴露，通常需要有人（开发者和审查者）仔细推演确保没有引入问题。（这也提示我们应尽量避免采用可能产生死锁或竞态条件的并发模型——否则会使代码评审或理解代码变得非常复杂。）

### 复杂性 {#complexity}

CL 是否比应有的更复杂？可以从以下几个层面进行审查：单行代码是否过于复杂？函数功能是否过于复杂？类结构是否过于复杂？所谓『过于复杂』，通常指 **『代码阅读者无法快速理解』**，也可能意味着 **『开发者在调用或修改该代码时容易引入错误』**。

其中一种复杂性就是 **过度工程化（over-engineering）**，即开发者使代码过度通用，或添加了系统当前并不需要的功能。代码审查者应特别警惕过度工程。应倡导开发者专注于解决已知的问题，而不是推测未来可能需要解决的问题。待未来问题真正出现且其具体的需求形态明朗时，才是着手解决的最佳时机。

### 测试 {#testing}

可以根据代码变更性质提交对应的单元、集成或端到端测试，除 [紧急情况](#emergency_changes) 外，测试代码通常应该跟生产代码在同一个 CL 中提交。

确保 CL 中的测试代码准确、合理且有效。测试代码不会自我验证，我们极少为测试再编写测试——必须由人工审查保证测试的有效性。

当代码损坏时，测试真的会失败吗？如果代码发生变化时，测试是否会误报？每个测试是否都进行了简洁有效的断言？不同测试方法的测试是否适当隔离？

谨记：测试代码同样需要维护。不要因为测试不属于主二进制文件就降低对它的要求。

### 命名 {#naming}

开发者是否为所有内容都提供了清晰的命名？一个好的名字不能太短，它要足以阐明项目的内容或作用，但又不会太冗长，以至于难以阅读。

### 注释 {#comments}

请确认开发者是否采用了清晰易懂的中文或英文（语言跟代码仓库一致）注释？所有注释是否有必要？通常来说，注释的价值在于解释这段代码**为什么**存在，而不是复述这段代码的行为逻辑。如果代码本身无法清楚到解释自己时，那应先简化代码而不是依赖注释。当然存在些例外（比如正则和复杂算法经常需要通过注释来说明其运作机制），多数情况下，注释应该包含代码本身没法包含的信息，比如这段代码背后的决策推理。

同时应注意查看本次 CL 前已有的注释，或许存在可立即移除的 TODO 注释，或可能包含反对当前修改的建议性注释等。

注意：代码注释与类、模块或函数的**文档**不同，后者应该明确说明一段代码的目的，如何使用它，以及使用时的行为方式。

### 风格 {#style}

Google 提供了所有主要语言的 [Google 代码风格指南](https://google.github.io/styleguide/)，甚至包括大多数小众语言。确保 CL 遵循适当的风格指南。

如果你想改进风格指南中没有的一些风格点，请在评论前加上 "Nit:"，让开发者知道这是一个你认为会改进代码的小瑕疵，但不是强制性。不要仅根据个人风格偏好阻止提交 CL。

CL 的作者不应该将重大的风格样式变更和其他变更结合在一块提交。它会让 CL 中难以看到正在变更的内容，会使合并和回滚更复杂，并导致其他问题。例如，如果作者想修改整个文件的代码风格样式，请让它仅将代码风格样式的修改作为一个 CL 提交，然后提交另一个关于功能变更的 CL。

### 一致性 {#consistency}

如果现有代码与风格指南不一致怎么办？请根据我们的 [Code Review 的标准](#code_review_standard)，风格指南是绝对权威：如果风格指南要求某些内容，CL 应该遵守指南。

在某些情况下，风格指南仅提供建议性规范而非强制性要求。此时需要判断新代码应当遵循指南建议还是与周边代码保持一致。除非会导致显著的理解障碍，否则应优先遵循风格指南。

如果没有其他规则适用，开发者应当保持与现有代码的一致性。

无论哪种方式，都应鼓励开发者提交错误并添加 TODO 注释，以便后续清理存量代码。

### 文档 {#documentation}

如果 CL 中更改了用户构建、测试、交互或发布代码的方式，请检查是否还更新了相关文档。包括 README、g3doc 文档和所有自动生成的参考文档。如果 CL 中删除或弃用了某些代码，需评估是否也应同步删除相应文档。若发现文档缺失，应及时要求补充。

### 每一行 {#every_line}

通常情况下，请仔细审查分配给你的**每行**代码。有些东西，比如数据文件、生成的代码或大型数据结构，你可以快速扫过，但对于人工编写的类、函数或代码块，不要流于表面地扫视便假定内容正确无误。当然，不同代码需要的审查深度可能有所不同——这需要你自行判断——但至少应确保你理解了所有代码的实际功能。

如果代码难以理解导致评审太慢，那么你应该及时告诉开发者，并等他们澄清后再继续评审。在 Google，我们聘用的都是卓越的软件工程师，而你就是其中之一。如果你都读不懂某段代码，那么其他开发者很可能同样难以理解。因此，要求开发者澄清代码不仅有助于当前评审，更是在帮助未来可能接触这段代码的开发者。

如果你理解了代码，但你觉得没有资格进行某些部分的审查，请确保 CL 上有一个合格的审查者 ，特别是对于隐私、安全、并发、可访问性、国际化等复杂问题。

### 异常 {#exceptions}

如果不需要全面的评审所有代码应该怎么处理？比如你作为多名评审者之一，可能会被要求：

- 仅评审大型变更中特定的文件。
- 仅关注代码的特定方面（如高层设计、隐私或安全影响等）。

这种情况下，可以通过评论明确说明您已评审的范围。建议在附加说明的前提下给予 [LGTM 评论](#lgtm_with_comments)。

如果你希望在确认其他评审者已完成对应部分审查后再授予 LGTM，应在评论中明确说明以设定预期。一旦 CL 达到理想状态，应该快速响应。

### 上下文 {#context}

从更宏观的视角审查 CL 往往能发现关键问题。代码评审工具通常只会显示变更区域部分的几行代码。但有时你必须查看整个文件才能确保修改的合理性。比如，你可能只看到新增了四行代码，但当查看完整文件时，会发现这四行正位于一个长达 50行 的方法中，而该方法现在确实需要拆分成多个小方法。

在整个系统的背景下考虑 CL 也很有用。这个 CL 是改善了系统的代码健康状况，还是会使整个系统变得更加复杂、测试更少等？ **绝不能接受导致代码健康度恶化的 CL。** 大多数系统的复杂性都是通过无数小变更累积形成的，因此防止新变更引入即便很小的复杂性也非常重要。

### 优秀实践 {#good_practices}

如果你在 CL 中看到一些优秀实践，请告诉开发者，尤其是当他们以很好的方式处理你的评论时。Code Review 通常只关注错误，但也应该鼓励和赞赏良好的实践。在指导方面，有些时候告诉开发者他们做对了什么比告诉他们做错了什么更有价值。

### 总结 {#summary}

在进行 Code Review 时，你应该确保：
- 代码架构设计良好。
- 该功能对代码用户是有好处的。
- 任何 UI 变更都合理且视觉协调。
- 任何并行编程都是安全的。
- 代码复杂度控制在必要的范围内。
- 开发者没有过度开发当前不需要的潜在功能。
- 代码有适当的单元测试。
- 测试设计完备。
- 命名规范清晰明确。
- 注释清晰有用，且大多数用来解释**为什么**而不是**做什么**。
- 代码文档完善（通常采用 g3doc 形式）。
- 遵循代码风格指南。

务必审查分配到的**每行代码**，结合**上下文**进行 Review ，确保**代码健康度得到提升**，并对开发者的**优秀实践**给予积极肯定。

## Code Review 的步骤 {#code_review_steps}

知道了 Code Review 的标准和关注点，那么如何最有效管理分布在多个文件中的 CL 呢？

1. 本次变更是否合理？[描述](#write_good_cl_description) 是否清晰？
2. 首先关注核心的修改部分，审视其整体设计是否良好？
3. 然后按合理顺序审查 CL 的其他内容。

### 第一步：全面了解变化 {#step_1_understand_the_change}

先查看 CL 的描述和整体修改内容，确保这项变更本身是否有意义，如果根本不需要，请立即回复并说明否决理由。在拒绝此类变更时，最好能同步给开发者替代方案的建议。

比如，你可以这样回应：『看起来你已经完成一些不错的工作，谢谢！但实际上，我们当前正在逐步淘汰你所修改的 FooWidget 系统，因此现阶段不再接受对其的新修改。不过，你来重构下新的 BarWidget 类怎么样？』

请注意，评审人不仅拒绝了当前 CL 并提供了替代方案，更始终保持着专业和礼貌。这种相互尊重的态度很重要，即便存在分歧，开发者之间也要彼此尊重。

如果频繁收到不符合预期的变更请求，建议重新审视团队的开发流程或对外贡献者指南，确保在代码编写前进行更充分的沟通。与其让他人付出大量心血后被迫废弃或重写，不如尽早明确方向以避免资源浪费。

### 第二步：检查 CL 的主要部分 {#step_2_review_the_main_parts_of_the_cl}

定位本次 CL 的主要文件。通常存在一个包含最多逻辑修改的主文件，并且它是 CL 的主要部分。优先审查这些核心内容有助于理解所有辅助性修改的上下文，从而提升代码评审效率。若因 CL 规模过大难以确定核心部分，请直接请开发者指明优先评审范围，或要求将 [CL 拆分为多个独立的变更集](#small_cl)。

如果 CL 的核心部分有重大的设计问题，要立即提出反馈，即使还没有时间完成全面的评审。因为如果对方的设计有严重问题，那继续审查当前 CL 的其他部分就是浪费时间，该作者后续的 CL 也变得无关紧要了。

立即提交重大设计意见至关重要，主要有两个原因：

1. 开发者提交 CL 后，往往会在评审期间立即基于该变更开展后续工作。若核心设计存在缺陷，其后续工作也将被迫返工。必须在其基于问题设计投入过多额外工作前及时制止。
2. 重大设计更改比小更改需要更长的时间。几乎所有的开发者都有最后期限；为了在截止日期前完成这些任务，还要保持高质量代码，开发者就需要尽快对 CL 进行返工。

### 第三步：按适当的顺序浏览 CL 的其余部分 {#step_3_review_the_rest_of_the_cl_in_order}

一旦你确认整个 CL 没有重大设计问题，尝试找出一个逻辑顺序来查看文件，同时确保你不会错过查看任何文件。通常，在浏览完主要文件后，最简单的方法是按照代码审查工具向你显示它们的顺序浏览每个文件。有时，在看主代码之前先看测试也很有帮助，因为这样你就会知道更改做了什么。

## Code Review 的速度 {#code_review_speed}

### 为什么 Code Review 应该很快？{#why_code_review_should_be_fast}

**在 Google，我们针对团队共同制作产品的速度进行优化，** 而不是针对单个开发者编写代码的速度进行优化。个人发展的速度很重要，但它并不如整个团队的速度那么重要。

当 Code Review 太慢时，会发生以下几种情况：

- **整个团队的速度降低。** 是的，

### Code Review 应该多快？{#how_fast_should_code_review_be}

### 速度 VS 中断 {#speed_vs_interruption}

### 快速响应 {#fast_response}

### 跨时区 Review {#review_across_timezones}

### LGTM 评论 {#lgtm_with_comments}

### 大型 CL {#large_cl}

### Code Review 随时间推移而改进 {#code_review_improves_over_time}

### 紧急情况 {#emergency_code_review}

## Code Review 的评论 {#code_review_comments}

## 如何处理审查者的评论 {#how_to_handle_reviewer_comments}

---

# 代码变更者指南 {#code_change_guide}

## 编写好的 CL 描述 {#write_good_cl_description}

## 小型 CL {#small_cl}

## 如何处理评审者的评论 {#how_to_handle_reviewer_comments}

---

# 紧急情况 {#emergency_changes}


